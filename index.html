<!DOCTYPE html>
<html>
<head>
<title>Roguelike Chess Web</title>
<meta charset="UTF-8">
<style>
  body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; }
  #board { display: grid; grid-template-columns: repeat(8, 60px); grid-template-rows: repeat(8, 60px); border: 2px solid black; }
  .square { width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; font-size: 40px; }
  .light { background: #f0d9b5; }
  .dark { background: #b58863; }
  .highlight { outline: 3px solid yellow; }
  #log { margin-top: 10px; width: 480px; height: 100px; overflow-y: auto; border: 1px solid black; padding: 5px; }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.13.4/chess.min.js"></script>
</head>
<body>
<h1>Roguelike Chess</h1>
<div id="board"></div>
<div id="log"></div>
<script>
const boardDiv = document.getElementById('board');
const logDiv = document.getElementById('log');
const game = new Chess();
let selectedSquare = null;
let upgrades = {};
let aiDepth = 2;

const pieceIcons = {
  'p': '♟', 'r': '♜', 'n': '♞', 'b': '♝', 'q': '♛', 'k': '♚',
  'P': '♙', 'R': '♖', 'N': '♘', 'B': '♗', 'Q': '♕', 'K': '♔'
};

function log(msg) {
  logDiv.innerHTML += msg + '<br>';
  logDiv.scrollTop = logDiv.scrollHeight;
}

function renderBoard() {
  boardDiv.innerHTML = '';
  const board = game.board();
  for (let rank = 7; rank >= 0; rank--) {
    for (let file = 0; file < 8; file++) {
      const squareColor = (rank + file) % 2 === 0 ? 'light' : 'dark';
      const div = document.createElement('div');
      div.className = `square ${squareColor}`;
      const piece = board[rank][file];
      if (piece) div.textContent = pieceIcons[piece.type === piece.type.toLowerCase() ? piece.type : piece.type.toUpperCase()];
      div.dataset.square = 'abcdefgh'[file] + (rank + 1);
      div.addEventListener('click', () => onSquareClick(div.dataset.square));
      boardDiv.appendChild(div);
    }
  }
}

function onSquareClick(square) {
  if (!selectedSquare) {
    const moves = game.moves({ square, verbose: true });
    if (moves.length) {
      selectedSquare = square;
      highlightMoves(moves);
    }
  } else {
    const move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
    clearHighlights();
    selectedSquare = null;
    if (move) {
      handleCapture(move);
      renderBoard();
      if (!game.game_over()) setTimeout(aiMove, 200);
    }
  }
}

function highlightMoves(moves) {
  clearHighlights();
  moves.forEach(m => {
    const sq = document.querySelector(`[data-square='${m.to}']`);
    if (sq) sq.classList.add('highlight');
  });
}

function clearHighlights() {
  document.querySelectorAll('.highlight').forEach(sq => sq.classList.remove('highlight'));
}

function aiMove() {
  const moves = game.moves();
  if (!moves.length) return;
  const move = moves[Math.floor(Math.random() * moves.length)];
  game.move(move);
  renderBoard();
}

function handleCapture(move) {
  if (move.captured) {
    const capturer = move.piece.toUpperCase();
    applyUpgrade(capturer);
  }
}

function applyUpgrade(pieceType) {
  log(`Upgrade acquired for ${pieceType}: special ability unlocked.`);
  // Example: store upgrade type for piece in upgrades object
  upgrades[pieceType] = "special";
}

renderBoard();
</script>
</body>
</html>
